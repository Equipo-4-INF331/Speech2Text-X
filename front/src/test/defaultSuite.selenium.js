// Generated by Selenium IDE
import { Builder, By, Key, until } from 'selenium-webdriver';
import { Options } from 'selenium-webdriver/firefox.js'; // IMPORTANTE para CI/CD
import assert from "assert";
import path from 'path';
import { fileURLToPath } from 'url';

// Configuración para rutas dinámicas
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

describe('Default Suite', function() {
  this.timeout(120000)
  let driver
  let vars

  async function loginUsuario() {
    await driver.get("http://localhost:5173/login")
    await driver.wait(until.elementLocated(By.css(".auth-label:nth-child(1) > .auth-input")), 10000);
    await driver.findElement(By.css(".auth-label:nth-child(1) > .auth-input")).sendKeys("test2@test.cl")
    await driver.findElement(By.css(".auth-label:nth-child(2) > .auth-input")).sendKeys("test12345")
    await driver.findElement(By.css(".auth-button")).click()
    await driver.wait(until.elementLocated(By.css(".upload-button")), 10000); 
  }

  beforeEach(async function() {
      // Aumenta un poco el timeout por si en CI se demora en levantar el browser
      this.timeout(60000);

      let options = new Options();

      if (process.env.CI) {
        console.log("Modo CI detectado: Ejecutando Headless (Firefox)");

        // --- CORRECCIÓN ---
        // En lugar de usar funciones que pueden no existir (.headless()),
        // agregamos los argumentos de línea de comando directamente.
        options.addArguments('--headless');
        options.addArguments('--no-sandbox'); // Vital para usuarios root/jenkins
        options.addArguments('--disable-dev-shm-usage'); // Evita problemas de memoria compartida
        options.addArguments('--width=1920');
        options.addArguments('--height=1080');
      }

      driver = await new Builder()
        .forBrowser('firefox')
        .setFirefoxOptions(options)
        .build();

      vars = {};
    });

  // ... Tests de Login se mantienen igual ...
  it('InicioSesionInvalido', async function() {
    await driver.get("http://localhost:5173/login")
    await driver.manage().window().setRect({ width: 550, height: 691 })
    const inputUser = await driver.wait(until.elementLocated(By.css(".auth-label:nth-child(1) > .auth-input")), 5000);
    await inputUser.sendKeys("jose")
    await driver.findElement(By.css(".auth-label:nth-child(2) > .auth-input")).sendKeys("dsafawdasfaw")
    await driver.findElement(By.css(".auth-button")).click()
    const error = await driver.wait(until.elementLocated(By.css(".auth-error-text")), 10000);
    await driver.wait(until.elementIsVisible(error), 5000);
    assert.strictEqual(await error.getText(), "Credenciales inválidas");
  })

  it('InicioSesionValido', async function() {
    await driver.get("http://localhost:5173/login")
    await driver.manage().window().setRect({ width: 1936, height: 1048 })
    const inputUser = await driver.wait(until.elementLocated(By.css(".auth-label:nth-child(1) > .auth-input")), 5000);
    await inputUser.sendKeys("test2@test.cl")
    await driver.findElement(By.css(".auth-label:nth-child(2) > .auth-input")).sendKeys("test12345")
    await driver.findElement(By.css(".auth-button")).click()
    const titulo = await driver.wait(until.elementLocated(By.css(".main-title")), 10000);
    assert.strictEqual(await titulo.getText(), "Speech2Text X")
  })

  // --- TEST DE SUBIDA DE ARCHIVO BLINDADO ---
  it('AgregarAudio', async function() {
    await loginUsuario();
    await driver.manage().window().setRect({ width: 1936, height: 1048 })
    
    await driver.findElement(By.css(".upload-button")).click()

    // 1. Ruta dinámica del archivo
    const audioPath = path.resolve(__dirname, 'assets', 'test_audio.mp3');
    
    // 2. Localizamos el input oculto
    const fileInput = await driver.findElement(By.id("hidden-audio-input"));

    await driver.executeScript("arguments[0].style.display = 'block'; arguments[0].style.visibility = 'visible';", fileInput);

    // 4. Ahora enviamos el archivo sin miedo
    await fileInput.sendKeys(audioPath);

    // Click en subir
    // Esperamos que el botón sea interactuable
    const btnPrimary = await driver.wait(until.elementLocated(By.css(".primary")), 5000);
    await btnPrimary.click()

    // Esperar toast (hasta 30s)
    const messageElement = await driver.wait(until.elementLocated(By.css('.message')), 30000);
    const toast = await messageElement.getText();

    // Validamos éxito genérico
    assert.ok(
        toast.includes("se subió correctamente") || toast.includes("xito") || toast.includes("Success"), 
        `Se esperaba un mensaje de éxito. Recibido: "${toast}"`
    );
  });

  // ... Resto de tests igual ...
  it('FechaIncorrecta', async function() {
    await loginUsuario();
    await driver.manage().window().setRect({ width: 550, height: 691 })
    const fechaDesde = await driver.wait(until.elementLocated(By.css("input:nth-child(4)")), 5000);
    await fechaDesde.click()
    await fechaDesde.sendKeys("2002-11-10")
    await driver.findElement(By.css("input:nth-child(6)")).click()
    await driver.findElement(By.css("input:nth-child(6)")).sendKeys("2001-10-10")
    const msg = await driver.wait(until.elementLocated(By.css("p")), 5000);
    assert.strictEqual(await msg.getText(), "La fecha hasta no puede ser anterior a la fecha desde")
  })

  it('FiltroFechaCorrecta', async function() {
    await loginUsuario();
    await driver.manage().window().setRect({ width: 550, height: 691 })
    const fechaDesde = await driver.wait(until.elementLocated(By.css("input:nth-child(4)")), 5000);
    await fechaDesde.click()
    await fechaDesde.sendKeys("2025-12-03")
    await driver.findElement(By.css("input:nth-child(6)")).sendKeys("2025-12-03")
    await driver.findElement(By.css("button:nth-child(7)")).click()
    const elements = await driver.wait(until.elementsLocated(By.css(".sidebar-item:nth-child(1)")), 5000);
    assert.ok(elements.length > 0)
  })
 
  it('ObtenerLinkDeCompartidoReal', async function() {
    await loginUsuario();
    await driver.manage().window().setRect({ width: 550, height: 691 })
    const item = await driver.wait(until.elementLocated(By.css(".sidebar-item:nth-child(5)")), 5000);
    await item.click()
    const btnShare = await driver.wait(until.elementLocated(By.css("div:nth-child(4) button")), 5000);
    await btnShare.click()
    await driver.findElement(By.css("div:nth-child(3) > div")).click()
    await driver.findElement(By.css("label:nth-child(3) > input")).click()
  })

  it('Probar el filtro', async function() {
    await loginUsuario();
    await driver.manage().window().setRect({ width: 550, height: 691 })
    const searchInput = await driver.wait(until.elementLocated(By.css("input:nth-child(1)")), 5000);
    await searchInput.click()
    await searchInput.sendKeys("TEXTO_QUE_NO_EXISTE_XYZ")
    await driver.findElement(By.css("button:nth-child(7)")).click()
    
    const msgElement = await driver.wait(
      until.elementLocated(By.xpath("//p[contains(text(), 'No hay transcripciones')]")), 
      5000
    );
    assert.strictEqual(await msgElement.getText(), "No hay transcripciones");
  })

  it('VerResumenes', async function() {
    await loginUsuario();
    await driver.manage().window().setRect({ width: 550, height: 691 })
    const searchInput = await driver.wait(until.elementLocated(By.css("input:nth-child(1)")), 5000);
    await searchInput.click()
    await searchInput.sendKeys("tmp_1762718820990") 
    await searchInput.sendKeys(Key.ENTER)
    await driver.findElement(By.css("button:nth-child(7)")).click()
    const resultItem = await driver.wait(until.elementLocated(By.css(".sidebar-item:nth-child(1)")), 5000);
    await resultItem.click()
    const editableTexts = await driver.wait(until.elementsLocated(By.css(".editable-text")), 5000);
    assert.ok(editableTexts.length > 0);
  })
})